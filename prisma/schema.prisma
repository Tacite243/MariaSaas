
generator client {
  provider = "prisma-client-js"
  // Important pour Electron : on bundle le moteur pour l'OS cible
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "sqlite"
  url = env("DATABASE_URL")
}


// Modèle User

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // Hashé
  name      String
  role      String   // Stocké en string, validé par Zod (SUPERADMIN, ADMIN, etc.)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLogin DateTime?

  // Pour le futur (Relation avec les ventes/audits)
  // sales    Sale[]
  // audits   AuditLog[]
  createdRequisitions Requisition[]
}

// --- GESTION DE STOCK ---

model Supplier {
  id        String   @id @default(uuid())
  name      String
  contact   String?
  phone     String?
  email     String?
  address   String?
  createdAt DateTime @default(now())
  
  requisitions Requisition[]
}


model Product {
  id          String   @id @default(uuid())
  
  // IDENTIFICATION
  name        String   // Nom commercial (ex: Doliprane)
  dci         String?  // Dénomination Commune Internationale (ex: Paracétamol)
  
  // CODIFICATION INTERNATIONALE
  code        String   @unique // Code barre principal (CIP13 ou EAN13) utilisé pour le scan
  codeCip7    String?  // Ancien code français (si besoin)
  codeAtc     String?  // Classe Anatomique (ex: N02BE01)
  
  // CARACTÉRISTIQUES
  category    String   @default("Générique") // ex: Analgésique
  form        String?  // ex: Comprimé, Sirop, Gel
  dosage      String?  // ex: 500mg, 1000UI
  packaging   String?  // ex: Boîte de 8, Flacon 100ml
  
  description String?
  isPrescriptionRequired Boolean @default(false) // Ordonnance obligatoire ?
  
  // GESTION STOCK
  minStock    Int      @default(5)
  maxStock    Int?     // Pour éviter le sur-stockage
  currentStock Int     @default(0)
  location    String?  // Emplacement physique (ex: Rayon A, Étagère 2)
  
  // PRIX
  sellPrice   Float    
  buyingPrice Float    @default(0)
  vatRate     Float    @default(0) // TVA (ex: 18.0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // RELATIONS
  lots             StockLot[]
  requisitionItems RequisitionItem[]
}

// Pour gérer l'onglet "Lots" et les péremptions
model StockLot {
  id           String   @id @default(uuid())
  batchNumber  String
  expiryDate   DateTime
  quantity     Int      // Quantité restante dans ce lot
  receivedDate DateTime @default(now())
  
  productId    String
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Requisition {
  id          String   @id @default(uuid())
  reference   String   @unique 
  status      String   @default("DRAFT")
  date        DateTime @default(now())
  // Relation avec Supplier (C'est ici qu'il manquait la définition pour fermer la boucle)
  supplierId  String
  supplier    Supplier @relation(fields: [supplierId], references: [id])
  
  // Relation avec User (Celui qui crée)
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])

  items       RequisitionItem[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model RequisitionItem {
  id            String      @id @default(uuid())
  requisitionId String
  requisition   Requisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  productId     String
  product       Product     @relation(fields: [productId], references: [id])
  quantity      Int
  buyPrice      Float
  batchNumber   String?     
  expiryDate    DateTime?   
}
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// --- UTILISATEURS ---
model User {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String
  name      String
  role      String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  lastLogin DateTime?

  createdRequisitions Requisition[]
  sales               Sale[] // Relation inverse ajoutée (Vendeur)
}

// --- GESTION DE STOCK ---
model Supplier {
  id        String   @id @default(uuid())
  name      String
  contact   String?
  phone     String?
  email     String?
  address   String?
  createdAt DateTime @default(now())

  requisitions Requisition[]
}

model Product {
  id                     String  @id @default(uuid())
  name                   String
  dci                    String?
  code                   String  @unique
  codeCip7               String?
  codeAtc                String?
  category               String  @default("Générique")
  form                   String?
  dosage                 String?
  packaging              String?
  description            String?
  isPrescriptionRequired Boolean @default(false)

  minStock     Int     @default(5)
  maxStock     Int?
  currentStock Int     @default(0)
  location     String?

  sellPrice   Float
  buyingPrice Float @default(0)
  vatRate     Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lots             StockLot[]
  requisitionItems RequisitionItem[]
  saleItems        SaleItem[] // Relation inverse ajoutée
}

model StockLot {
  id           String   @id @default(uuid())
  batchNumber  String
  expiryDate   DateTime
  quantity     Int
  receivedDate DateTime @default(now())

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  saleItems SaleItem[] // Relation inverse ajoutée (Traçabilité lot vendu)
}

model Requisition {
  id        String   @id @default(uuid())
  reference String   @unique
  status    String   @default("DRAFT")
  date      DateTime @default(now())

  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  items RequisitionItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RequisitionItem {
  id            String      @id @default(uuid())
  requisitionId String
  requisition   Requisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  productId     String
  product       Product     @relation(fields: [productId], references: [id])
  quantity      Int
  buyPrice      Float
  batchNumber   String?
  expiryDate    DateTime?
}

// --- CRM ---
model Client {
  id                String  @id @default(uuid())
  code              String  @unique
  name              String
  phone             String?
  email             String?
  address           String?
  insuranceProvider String?
  insuranceNumber   String?

  sales     Sale[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- VENTES & POS ---
model Sale {
  id             String   @id @default(uuid())
  reference      String   @unique
  subTotal       Float
  taxAmount      Float    @default(0)
  discountAmount Float    @default(0)
  totalAmount    Float
  paymentMethod  String
  status         String   @default("COMPLETED")
  date           DateTime @default(now())

  sellerId String
  seller   User   @relation(fields: [sellerId], references: [id])

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  items SaleItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SaleItem {
  id     String @id @default(uuid())
  saleId String
  sale   Sale   @relation(fields: [saleId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  stockLotId String?
  stockLot   StockLot? @relation(fields: [stockLotId], references: [id])

  quantity  Int
  unitPrice Float
  costPrice Float
  taxRate   Float @default(0)
  total     Float
}

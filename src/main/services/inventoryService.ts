import { prisma } from '../lib/prisma';
import { CreateRequisitionInput } from '../../shared/schemas/inventorySchema';
import { RequisitionStatus } from '../../shared/types';


function generateInternalEAN13() {
    // Préfixe interne (20-29 sont réservés usage interne)
    const prefix = "20";
    const timestamp = Date.now().toString().slice(-9); // 9 derniers chiffres du temps
    const code = prefix + timestamp + "0"; // 12 chiffres temporaires

    // Calcul clé de contrôle EAN13 (Modulo 10)
    let sum = 0;
    for (let i = 0; i < 12; i++) {
        sum += parseInt(code[i]) * (i % 2 === 0 ? 1 : 3);
    }
    const checksum = (10 - (sum % 10)) % 10;

    return prefix + timestamp + checksum;
}

export class InventoryService {

    // --- PRODUITS ---

    async createProduct(data: any) {
        // Si aucun code n'est fourni, on en génère un conforme EAN13
        if (!data.code || data.code.trim() === '') {
            data.code = generateInternalEAN13();
        }

        // Vérification unicité (Safety check)
        const existing = await prisma.product.findUnique({ where: { code: data.code } });
        if (existing) throw new Error(`Le code ${data.code} est déjà attribué au produit "${existing.name}"`);

        // Protection Métier : Le stock initial est TOUJOURS 0
        // On force la suppression de tout champ 'quantity' ou 'currentStock' parasite
        const { quantity, currentStock, ...cleanData } = data;

        return await prisma.product.create({
            data: {
                ...cleanData,
                currentStock: 0, // Force à 0
                buyingPrice: cleanData.buyingPrice || 0, // Prix de référence seulement
                sellPrice: cleanData.sellPrice || 0
            }
        });
    }

    async getAllProducts() {
        return await prisma.product.findMany({
            include: {
                lots: {
                    where: { quantity: { gt: 0 } }, // On ne récupère que les lots non vides
                    orderBy: { expiryDate: 'asc' } // Le plus vieux en premier (FEFO)
                }
            },
            orderBy: { name: 'asc' }
        });
    }

    // --- FOURNISSEURS ---
    async createSupplier(data: { name: string; phone?: string }) {
        return await prisma.supplier.create({ data });
    }

    async getAllSuppliers() {
        return await prisma.supplier.findMany();
    }

    // --- RÉQUISITIONS (Entrée Stock) ---

    // 1. Créer un BROUILLON
    async createDraftRequisition(data: CreateRequisitionInput) {
        const reference = `REQ-${Date.now().toString().slice(-6)}`; // Générateur simple de ref

        return await prisma.requisition.create({
            data: {
                reference,
                status: RequisitionStatus.DRAFT,
                supplierId: data.supplierId,
                createdById: data.createdById,
                items: {
                    create: data.items.map(item => ({
                        productId: item.productId,
                        quantity: item.quantity,
                        buyPrice: item.buyPrice,
                        batchNumber: item.batchNumber,
                        expiryDate: item.expiryDate
                    }))
                }
            },
            include: { items: { include: { product: true } }, supplier: true }
        });
    }

    // 2. VALIDATION (Transaction Critique)
    async validateRequisition(requisitionId: string) {
        return await prisma.$transaction(async (tx) => {
            const requisition = await tx.requisition.findUnique({
                where: { id: requisitionId },
                include: { items: true }
            });

            if (!requisition || requisition.status !== RequisitionStatus.DRAFT) {
                throw new Error("Réquisition invalide");
            }

            for (const item of requisition.items) {
                // 1. Mise à jour du stock global et du prix d'achat
                await tx.product.update({
                    where: { id: item.productId },
                    data: {
                        currentStock: { increment: item.quantity },
                        buyingPrice: item.buyPrice // Mise à jour du dernier prix d'achat connu
                    }
                });

                // 2. CRÉATION DU LOT PHYSIQUE (Pour l'onglet "Lots")
                if (item.batchNumber && item.expiryDate) {
                    await tx.stockLot.create({
                        data: {
                            productId: item.productId,
                            batchNumber: item.batchNumber,
                            expiryDate: item.expiryDate,
                            quantity: item.quantity,
                            receivedDate: new Date()
                        }
                    });
                }
            }

            return await tx.requisition.update({
                where: { id: requisitionId },
                data: { status: RequisitionStatus.VALIDATED },
                include: { items: true }
            });
        });
    }

    async getRequisitions() {
        return await prisma.requisition.findMany({
            include: { supplier: true, createdBy: true },
            orderBy: { createdAt: 'desc' }
        });
    }
}

export const inventoryService = new InventoryService();